services:
  base:
    image: node
    volumes:
      - .:/app
      - ./db:/db
    environment:
      - NODE_ENV=development

      - SMTP_SERVER=smtp.mailtrap.io
      - SMTP_PORT=2525
      - SMTP_USER=4544d25b466838
      - SMTP_PASSWORD=02bad9670588c0
      - SMTP_FROM=info@stripeshop.top

      - API_HOST=api
      - API_PORT=3002

      - APP_HOST=app
      - APP_PORT=3000

      - STATIC_SERVER=vite

      - STATIC_PATH=./dist
      - DB_FILE=/db/stripeshop.db

      - BASE_URL=http://localhost:3002

    working_dir: /app
    command: ./scripts/setup_dev.sh

  app:
    depends_on:
      base:
        condition: service_completed_successfully
    extends:
      service: base
    ports:
      # exposed for vite to be able to open a websocket there
      - 3000:3000
    command: npx vite --host

  api:
    depends_on:
      base:
        condition: service_completed_successfully
    extends:
      service: base
    ports:
      - 3002:3002
    command: npm run api
